using Microsoft.Extensions.Logging.Abstractions;
using Microsoft.Maui.Graphics;
using RadioLib.Image;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace RadioMaui
{
    public class CnavasTest : IDrawable
    {
        string kh_path_test = "m 426.20191,330.79242 1.46,-0.21 -0.23,1.26 -1.14,-0.33 -1.49,-1.55 0.71,0.12 0.69,0.71 z m -73.15,-3.46 3.38,0.6 3.46,1.12 1.69,-0.33 1.8,-1.11 1.22,1.01 0.96,0.16 0.42,-0.49 1.16,0.83 1.97,0.17 0.92,0.55 -1.26,0.36 -5.22,-0.39 -10.91,-2.42 0.41,-0.06 z m 64.55,-2.76 -0.59,0.41 -0.2,0.7 -1.16,0.62 0.14,1.36 -0.25,0 -0.4,-1.76 1.32,-1.28 1.14,-0.05 z m 12.09,-0.67 1.27,8.04 3.21,8.76 0,0 -0.55,0.29 0,0 -0.77,-2.6 -0.75,-1.02 -0.6,0.13 -0.31,1.09 -0.67,0.65 -0.78,0.11 -0.27,-0.66 0.7,-1.65 0.41,-2.96 -0.44,-0.53 -0.02,-0.87 1.11,1.11 -0.86,-2.19 -0.65,-0.27 0.17,-1.04 -0.39,0.04 -0.31,-1.64 -0.62,-0.65 -0.63,0.09 -0.54,2.01 -0.74,-1.47 -0.98,-0.52 0.35,-0.83 -0.28,-0.71 -1.3,-0.52 -0.01,-0.48 1.71,0.3 1.34,-0.5 0.54,1.48 0.37,0.15 0.62,-0.89 -0.3,-2.24 0.68,-0.58 0.29,0.57 z m -108.24,-5.23 1.62,-0.22 0.2,0.25 -0.69,0.21 -0.1,0.35 10.09,2.49 -8.71,-1.94 -3.38,-1.27 -1.78,-1.47 -0.94,-1.64 -0.13,-1.88 0.41,-0.84 0.32,0.07 -0.05,2.51 0.36,1.28 0.85,1.11 1.93,0.99 z m 49.58,-65.93 2.61,0.62 2.16,-0.51 0.12,0.88 -0.62,0.63 -0.12,0.73 0.94,0.07 1.2,-0.73 0.25,0.18 -0.09,1.42 0.97,0.54 0.06,0.99 1.27,-0.54 -0.72,-0.89 -0.07,-0.62 5.37,-1.02 -0.3,-2.14 3.42,-0.69 0.52,1.26 0.52,0.12 -0.11,0.65 -0.51,0.18 -0.02,2.65 1.51,-0.51 0.29,1.43 9.73,-1.56 1.37,2.09 0.93,0.78 4.79,-0.96 0,0 2.89,1.51 0.58,0.64 0.62,3.64 0.45,-0.02 0.67,4.02 0.45,0.37 0.77,-0.79 0.97,-0.13 0.57,0.47 0.91,-0.19 -0.1,-0.52 0.68,-0.14 -0.13,-1.13 3.42,-0.67 -0.15,0.82 -1.09,0.33 0.34,1.66 0.96,-0.15 0.27,0.79 0.12,0.81 -1.31,0.24 0.98,7 1.11,-0.1 0.48,4.17 0.76,-0.1 0.31,1.51 0.65,0.03 0.12,0.98 2.08,-0.26 0.13,1.04 1.65,-0.26 0.58,4.06 1.73,-0.15 0.41,2.67 -2.04,0.31 0.27,2.12 -0.5,0.02 -0.01,1.06 -0.47,0.03 0.01,0.44 -2.67,0.37 0.06,0.65 -1.11,0.16 0.27,1.82 1.6,-0.18 0.1,0.66 2.11,-0.27 0.32,2.81 -1.44,0.41 0.31,1.77 0.89,-0.03 0.27,1.55 4.53,-0.72 0.18,1.33 -0.46,0.13 0.31,1.5 1.8,-0.27 2.59,1.6 1.13,-0.15 0.61,8.94 0.97,-0.09 0,0 -0.86,1.1 -1.39,0.86 -4.7,1 -2.14,1.75 -0.69,2.1 -1.29,0.06 -0.51,-0.66 -0.94,0.26 -1.58,-0.76 -1.92,0.52 -0.2,1.18 0.73,2.61 -1.25,3.13 -0.65,1.08 -1.44,1.32 -0.3,-0.56 -0.46,-0.21 -0.33,0.24 -0.54,0.49 -0.51,1.39 -0.33,-1.63 0.3,-0.66 -0.47,-0.45 -1.67,-0.42 0.06,-0.6 0.53,-0.78 1.54,0.24 0,-0.31 -1.17,-0.21 -0.3,-1.61 0.77,-0.6 0.49,-0.94 -0.16,-0.4 0.4,0.06 0.36,1.71 0.42,-1.38 1.41,-0.57 0.69,1.28 -0.04,0.27 -0.45,-0.08 0.05,0.44 0.57,0.21 0.63,-1.43 0.07,-2.41 -0.8,-0.5 -0.75,-1.07 -0.47,0.03 -0.36,0.51 0,0.72 0.56,1.09 -0.93,0.24 -0.14,0.4 -0.97,-0.21 -0.8,-0.74 -0.45,0 -0.26,-0.69 -0.4,-0.01 -1.37,-1.42 -0.99,0.25 -0.58,-0.9 0.07,-0.96 -0.57,-1.23 -0.54,-0.14 0.52,1.45 -0.49,1.76 0.41,1.25 0.65,-0.24 0.26,0.39 -0.65,1.11 -0.15,1.7 -0.69,0.17 -0.11,-2.63 -1.16,-1.32 -0.79,-2.3 -0.75,-0.62 -0.44,-1.17 -0.97,-1.11 -0.5,0.03 -0.49,1.39 -0.8,-0.7 -0.43,0.5 1.48,0.43 1.02,3.11 0.96,0.87 -0.15,0.61 -1.48,1.16 -0.35,-0.43 0.64,-1.58 -0.5,-1.36 -0.62,-0.19 -0.43,1.4 -0.87,0.29 0.14,0.24 0.69,-0.33 0.47,0.42 0.31,0.59 -0.13,0.71 0.8,0.55 -0.49,0.96 -0.49,-0.95 -0.54,-0.33 -0.65,0.84 -0.48,-0.07 -0.06,-1.03 -0.73,-0.68 -0.7,1.08 0.03,0.92 -2.35,-4.26 -0.99,-0.78 -0.8,-0.21 -0.95,0.34 -0.52,-0.81 -0.38,0.52 -1,0.17 -2.12,-1.69 -0.29,0.65 -1.46,0.04 -0.21,0.69 0.75,1.35 -0.67,0.13 -0.91,-0.47 -0.54,-0.45 -0.1,-0.56 -0.36,0.17 -0.84,-0.82 0.15,0.59 0,0 -0.98,0.17 0.73,4.23 -0.7,0.25 0,0 -0.27,-0.71 -0.86,-0.45 -0.65,1.08 -0.53,0 -0.3,0.88 -0.46,0.12 -0.45,-0.34 0.17,1.17 1.55,1.13 -1.5,-0.31 -0.66,0.32 -0.17,1.06 0.82,1.16 -0.89,-0.07 -1.03,-0.85 -1.12,0.41 -0.12,0.52 -2.96,-3.99 -0.28,-0.11 -0.48,0.45 -0.19,1.4 -0.85,-0.14 -0.07,-0.65 0.63,0 0.29,-1.41 -0.79,-0.59 -1.01,-0.29 -1.23,0.33 -0.3,0.19 -0.01,1.14 -0.32,-0.18 0.15,-1.24 0.75,-0.94 -0.71,-1.03 0.65,-2.09 -0.75,1.32 -0.55,-0.17 0.28,0.71 -0.43,1.16 -1.84,1.52 -1.59,-0.59 -0.48,-0.86 -1.19,-0.12 -0.33,0.37 0.31,0.51 -0.51,0.75 0.41,0.49 -0.48,0.19 -1.66,-0.09 -0.99,0.31 -2.67,-0.54 -0.92,0.29 -2.06,-0.61 -0.84,0.29 -0.18,0.41 -2.08,0.45 -0.81,-0.37 -1.67,0.38 -1.98,0.95 -0.18,0.46 0.26,0.2 -1.73,-0.4 -9.89,-3.09 0.76,0.14 0.41,-0.62 -0.3,-1.04 0.13,-0.24 0.15,0.34 0.3,-0.12 -0.28,-0.73 -1.08,-0.32 -0.47,0.43 0.4,0.31 -0.37,-0.04 -1.3,-1.36 -0.88,0.01 -1.31,-0.98 -0.47,-1.29 -0.92,-0.4 -0.46,0.44 -2.1,-0.36 -0.68,-0.67 -0.37,-1.03 -1.51,-0.33 -0.65,1.36 -2.99,-0.15 -0.36,0.38 -0.16,-1.41 -0.6,-0.12 0.2,-0.56 0.91,-0.72 1.42,-0.56 3.02,-0.08 1.34,-0.41 1.43,-0.69 0.51,-0.92 0.89,-0.05 0.57,-0.47 -1.06,-2.53 -0.56,-0.6 -0.47,-0.11 -0.88,0.7 -0.68,0.03 -4.98,-1.94 0,0 0.54,-0.92 0.8,-0.04 0.38,-0.89 0,0 0.69,0.27 0.85,-0.34 0.19,0.38 2.62,0.95 2.07,0.11 1.07,-0.41 1.64,-0.04 2.55,0.93 2.07,0.11 2.77,0.71 2,-0.41 0.74,-0.7 0.09,-0.42 -0.79,-0.12 -1.27,0.26 -0.88,0.48 -0.08,0.37 -0.6,0 -1.17,-0.77 0.75,-0.23 -0.05,-0.35 -1.05,-0.2 1.24,-0.08 -0.6,-0.25 -0.17,-0.63 0.52,-0.5 -0.55,-0.46 0.47,-0.09 0.04,-0.98 -0.32,-0.4 -1.66,-0.85 -3.66,1.64 -1.2,-2.69 -1.66,-0.11 -2.36,-1.99 0,0 0.17,-0.47 1.42,-0.08 -0.39,-0.55 2.27,-0.37 -0.32,-2.19 -0.45,0.07 -0.18,-0.81 1.65,-0.41 0.31,0.27 1.71,-0.29 0.19,-0.54 1.62,-0.36 -0.21,-1.72 1.24,-0.63 -0.83,-1.44 4.17,2.65 0.91,-0.09 -0.25,-1.72 3.28,-0.54 0.23,1.22 2.09,-0.27 -0.21,-1.25 0.44,-0.1 -0.27,-1.57 0.37,-0.05 0.09,0.62 0.93,-0.15 0.41,0.91 3.57,-0.26 0.26,1.95 2.02,-0.32 0.36,0.33 0.14,-0.52 1.35,-0.16 0.04,-0.37 4.59,-0.83 -0.09,-0.56 -0.86,0.15 -0.16,-0.86 -2.09,0.36 -0.43,-0.19 -0.1,-0.87 3,-0.68 -0.12,-0.8 1.95,-0.25 -0.15,-0.77 -0.92,0.1 -0.63,-2.03 0.68,-0.61 2.43,1.34 1.54,-2.41 -4.59,-2.81 -0.84,-2.32 1.39,-1.92 0.29,-1.26 1.52,0 0.07,-0.32 0.38,0.79 0.73,0.12 -0.05,-0.45 0.99,-0.63 0.02,-0.97 1.09,-0.16 0.51,0.87 0.56,0.09 0.45,-0.3 -0.44,-0.39 0.05,-0.77 1.65,-0.25 -1.43,-1.63 -0.68,-0.55 -0.45,0.02 -0.06,-2.06 1.09,-0.49 -0.42,-2.77 -2.82,0.45 -0.17,-0.38 -0.14,-2.94 0.75,-0.24 -0.03,-0.91 0.53,-0.21 0.14,3.02 2.23,-0.34 -0.44,-4.35 0.76,-0.41 -0.16,-1.13 -0.14,-0.3 -1.52,0.92 -0.12,-2.73 z";
        
        public void Draw(ICanvas canvas, RectF dirtyRect)
        {
            var mapFileContent = GetMapContent("Image\\ukraine.svg");

            var svgFile = SimpleSvg.LoadFromText(mapFileContent);

            //canvas.FillColor = Colors.LightBlue;
            //canvas.FillRectangle(0, 0, (float)svgFile.Width, (float)svgFile.Height);






            foreach (var path in svgFile.Paths)
            {
                DrawPath(canvas, path.Path);
            }
        }

        private void DrawPath(ICanvas canvas, string pathData)
        {
            var points = pathData.Split(' ');

            var path = new PathF();
            bool move = false;

            for (int i = 0; i < points.Length; i++)
            {
                if (points[i] == "m")
                {
                    move = true;
                    continue;
                }

                if (points[i] == "z")
                {
                    path.Close();
                    canvas.DrawPath(path);

                    continue;
                }

                var values = points[i].Split(',');
                var point = new PointF(float.Parse(values[0], CultureInfo.InvariantCulture.NumberFormat), float.Parse(values[1], CultureInfo.InvariantCulture.NumberFormat));

                if (move)
                {
                    move = false;
                    path.MoveTo(path.LastPoint.X + point.X, path.LastPoint.Y + point.Y);
                }
                else
                {
                    path.LineTo(path.LastPoint.X + point.X, path.LastPoint.Y + point.Y);
                }
            }
        }

        public string GetMapContent(string filePath)
        {
            Task<string> task = Task.Run<string>(async () => await ReadTextFile(filePath));
            return task.Result;
        }

        private async Task<string> ReadTextFile(string filePath)
        {
            using Stream fileStream = await FileSystem.Current.OpenAppPackageFileAsync(filePath);
            using StreamReader reader = new StreamReader(fileStream);
            return reader.ReadToEnd();
        }
    }
}
